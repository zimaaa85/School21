# Basic CI/CD


## Part 1. Настройка gitlab-runner

##### Поднять виртуальную машину *Ubuntu Server 22.04 LTS*
##### Скачать и установить на виртуальную машину **gitlab-runner**
- Поднимем виртуальную машину Ubuntu Server 22.04 LTS:
    - если нужно обновить до нужной версии выполним следующие команды<br>
        - lsb_release –a - узнать версию
        - sudo apt update
        - sudo apt upgrade
        - sudo apt dist-upgrade
        - sudo do-release-upgrade
        - и ждем, соглашаемся (ставим Y).
        - lsb_release –a - проверяем версию<br>
    ![Part_1](Part_1/0.png)

- Скачивание на виртуальную машину gitlab-runner<br>
   - curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh" | sudo bash:<br>
    ![Part_1](Part_1/1.png)

- Установка gitlab-runner <br>
    ![Part_1](Part_1/2.png)

- Запуск gitlab-runner и зарегистрация его для использования в текущем проекте (DO6_CICD)<br>
    ![Part_1](Part_1/3.png)   

- Для регистрации понадобятся URL и токен, которые можно получить на страничке задания на платформе<br>
    ![Part_1](Part_1/4.png)


## Part 2. Сборка

#### Написать этап для **CI** по сборке приложений из проекта *C2_SimpleBashUtils*:
##### В файле _gitlab-ci.yml_ добавить этап запуска сборки через мейк файл из проекта _C2_
##### Файлы, полученные после сборки (артефакты), сохранять в произвольную директорию со сроком хранения 30 дней.

- Переношу написанный **cat** и **grep** из первого проекта, создаю файл **.gitlab-ci.yml** (должен распологаться в корне проекта) добавля стадию сборки через **make**. Файлы, полученные после сборки (артефакты), сохрани в произвольную директорию со сроком хранения 30 дней<br>
    ![Part_2](Part_2/1.png)

- Если всё сделано верно в файле **.gitlab-ci.yml** нет ошибок то после пуша в гите отобразится успешное выполнение стадии<br>
    ![Part_2](Part_2/2.png)
    - Файл .gitlab-ci.yml - это файл конфигурации для настройки и определения задач и пайплайнов непрерывной интеграции и непрерывной доставки (CI/CD) в GitLab. В этом файле вы описываете, какие шаги должны выполняться автоматически при каждом пуше кода в ваш репозиторий. После добавления .gitlab-ci.yml файла в ваш репозиторий, GitLab CI/CD будет автоматически создавать пайплайны и выполнять задачи согласно вашим настройкам. Вы сможете видеть результаты выполнения задач в веб-интерфейсе GitLab, а также настраивать уведомления, автоматическое развертывание и другие аспекты CI/CD процесса<br>



## Part 3. Тест кодстайла

#### Написать этап для **CI**, который запускает скрипт кодстайла (*clang-format*):

- Добавляю в файл **.gitlab-ci.yml** стадию проверки стиля.<br>
    ![Part_3](Part_3/1.png)
    ![Part_3](Part_3/2.png)

##### Если кодстайл не прошел, то "зафейлить" пайплайн
##### В пайплайне отобразить вывод утилиты *clang-format*

- В случае если проверка на стиль и последующая сборка прошла успешно.<br>
    ![Part_3](Part_3/3.png)
    ![Part_3](Part_3/3_1.png)

- Случай если кодстайл не прошёл.<br>
    ![Part_3](Part_3/4.png)
    ![Part_3](Part_3/4_1.png)


## Part 4. Интеграционные тесты

#### Написать этап для **CI**, который запускает ваши интеграционные тесты из того же проекта:

- Добавляю стадию тестирования.<br>
     ![Part_4](Part_4/1.png)
       ![Part_4](Part_4/1_1.png)
       ![Part_4](Part_4/1_2.png)

##### Запускать этот этап автоматически только при условии, если сборка и тест кодстайла прошли успешно
-    ![Part_4](Part_4/2.png)

##### Если тесты не прошли, то "зафейлить" пайплайн

- Если в тестах есть хоть один FAIL то пайплайн провален.<br>


##### В пайплайне отобразить вывод, что интеграционные тесты успешно прошли / провалились

- Если FAIL отсутствуют, пайплайн завершается статусом succes.<br>
    ![Part_4](Part_4/3.png)
    ![Part_4](Part_4/3_1.png)


## Part 5. Этап деплоя

#### Поднять вторую виртуальную машину *Ubuntu Server 22.04 LTS*

-  Создаем новую машину и связываем ее с первой<br>
    ![Part_5](Part_5/0.png)
    ![Part_5](Part_5/1.png)
    ![Part_5](Part_5/2.png)

- Установка SSH-демон для активации порта 22, нужно использовать команду: *"sudo apt-get install openssh-server"*.<br>
     ![Part_5](Part_5/2_1.png)

- Прокинем ssh ключ на вторую машину:<br>
    ![Part_5](Part_5/3.png)
    ![Part_5](Part_5/4.png)
    ![Part_5](Part_5/5.png)

- Дадим доступ к папку /usr/local/bin на второй машине:<br>
    ![Part_5](Part_5/6.png)

#### Напиши этап для CD, который «разворачивает» проект на другой виртуальной машине:
- Напишем скрипт, где происходит копирование файлов, которые скомпилировались:<br>
    ![Part_5](Part_5/7.png)
    ![Part_5](Part_5/8.png)

##### Запусти этот этап вручную при условии, что все предыдущие этапы прошли успешно:
    ![Part_5](Part_5/9.png)

- Запустим в ручную и посмотрим на второй машине, те файлы которые должны скопироваться:<br>
    ![Part_5](Part_5/10.png)

- Посмотрим на второй машине, скопированные файлы:<br>
    ![Part_5](Part_5/11.png)


## Part 6. Дополнительно. Уведомления

##### Настроить уведомления о успешном/неуспешном выполнении пайплайна через бота с именем "[ваш nickname] DO6 CI/CD" в *Telegram*

- используем в Telegram "Botfather". Для этого используем инфраструктуру телеграма, а точнее главного бота "BotFather". Выполняем команды указаные ниже и получаем токен:<br>
    ![Part_6](Part_6/0.png)

- далее необходимо получить id чата. Для этого в адресной строке браузера забиваем `https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates`, уже находясь на указанной странице отправьте любое сообщение в чат бота. На странице отобразятся данные, включая id чата в который вы отправили сообщение (поле chat->id):<br>
    ![Part_6](Part_6/0_1.png)

- напишем скрипт, который отравляет сообщения в  Telegram:<br>
    ![Part_6](Part_6/1.png)

- допишем .gitlab-ci.yml, чтобы запускать скрипт:<br>
    ![Part_6](Part_6/2.png)

- Посмотрим на результат, здесь должно придти сообщение, что все работает:<br>
    ![Part_6](Part_6/3.png)
    ![Part_6](Part_6/4.png)
    
- Сделаем ошибки в тесте, и посмотрим какое сообщение придет:<br>
    ![Part_6](Part_6/5.png)
    ![Part_6](Part_6/6.png)


### Вся информация о gitlab есть на сайте https://docs.gitlab.com/
